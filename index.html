<html>
<head>
	<title>Nodemath</title>
	<style>
		#questionContainer {
			display:none;
		}
		#nameError {
			margin: 3px;
			color: red;
			font-size: 12px;
		}
		#gameResult {
			 display:none;
		}
		#gamePoints {
 	 		 display:none;
		}
		ul {
			list-style: none;
			padding-left:0;
		}
		.player {
			list-style-type:none;
		}
	</style>

</head>

<body>

	<div><strong>Welcome to the Math Trivia RT game</strong><br/>
	</div>
	
	<div id="players">
		<div id="playerCount"></div>
		<div id="playerScores"></div>
	</div>

	<div id="playerNameEntry">
		<br/><span>Player name:<span>
		<form id="playerNameForm">
			<input size="40" id="playername"></input>
			<input type="submit"></input>
		</form>
		<div id="nameError"></div>
	</div>


	<div id="questionContainer">
		<div id="question"><br/>Your question will display here when a second player joins...</div>
		<form id="answerform">
				<input size="5" id="answer"></input>
				<input type="submit"></input>
		</form>
		<div id="answer_received"></div>
	</div>

	<div id="gameResult">
		<div id="winner">Winner: </div>
	</div>

	<div id="gamePoints">
		<div id="points">Your points: </div>
	</div>


<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
	jQuery(function($){
		var socket = io.connect();
		var $playerForm = $('#playerNameForm');
		var $playerError = $('#nameError');
		var $playerName = $('#playername');
		var $players = $('#players');
		var $playerCount = $('#playerCount');
		var $playerScores = $('#playerScores');
		var $question = $('#question');
		var $answerForm = $('#answerform');
		var $answer = $('#answer');
		var $answerReceived = $('#answer_received');
		var $gameOutcome = $('#gameResult');
		var $gameWinner = $('#winner');
		var $gamePoints = $('#gamePoints');
		var $pointTotal = $('#points');

		$answerForm.submit(function(e) {
			e.preventDefault();
			socket.emit('send answer', $answer.val());
			$answer.val('');
		});

		$playerForm.submit(function(e) {
			e.preventDefault();
			if( document.getElementById('playername').value === '' ){
     			alert('Please enter a player name.');
     			return;
    		}

			socket.emit('new player', $playerName.val(), function(data) {
				if(data) {
					$('#playerNameEntry').hide();
					$('#questionContainer').show();
					$('#players').show();
					$('#playerScores').show();
				}
				else {
					$playerError.html('Error: that player name is already in use, try again.');
				}
			});
			$playerName.val('');
		});

		socket.on('new game', function(game) {
			$question.html('<br/>' + game);
		});

		socket.on('score update', function(data) {
			var html;
			
			// Check each score retrieved to see if it matches any of our current players
			$(data).each(function(key, score) {
				$('ul li').each(function() {
					text = $(this).text();
					
					// Do a check in case the game has already started and the pts are showing
					if(text.indexOf(" (") != -1 ) {
						text = text.substr(0,text.indexOf(" ("));
					}
					
					// If they are exactly the same, replace the string with the current point total
					if(text.valueOf() == score.name.valueOf()) {
						if(score.score == 1)
							$(this).html('<li class="player">' + score.name + ' (' + score.score + ' point)');
						else
							$(this).html('<li class="player">' + score.name + ' (' + score.score + ' points)');
					}
				});
			});
		});

		socket.on('game over', function(data) {
			$('#gameResult').show();
			$gameWinner.html("You are the " + data + "!");
		});

		socket.on('players', function(data) {
			var playercount = 0;
			if(data.length > 0) {
				playercount = data.length;
			}
			
			// Set up the player list and show the count
			var html_list = '<ul>';
			var html = '<br/><strong>Player List</strong> (' + playercount +' connected)</br>';
			for (i=0; i < data.length; i++)
			{
				html_list += '<li class="player">' + data[i];
			}
			html_list += '</ul>';
			$playerCount.html(html);
			$playerScores.html(html_list);
		});

		socket.on('new answer received', function(data) {
			// Not implemented
		});

	});
</script>

</body>
</html>